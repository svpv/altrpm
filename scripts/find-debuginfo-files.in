#!/bin/sh -efu
#
# find-debuginfo-files - make %files list for debuginfo package
#
# Written by Alexey Tourbin <at@altlinux.org>.
# License: GPLv2+.

. @RPMCONFIGDIR@/functions
ValidateBuildRoot

cd "$RPM_BUILD_ROOT"

rm -rf .tmp
mkdir .tmp

>.tmp/files
>.tmp/links
>.tmp/src

while read -r f; do
	f=${f#$RPM_BUILD_ROOT}
	debugf=./usr/lib/debug$f.debug
	if [ -L "$debugf" ]; then
		continue
	fi
	if [ -f "$debugf" ]; then
		printf '%s\n' "${debugf#.}" >>.tmp/files
	fi
	if [ -f .debuginfo/links/"$debugf" ]; then
		cat .debuginfo/links/"$debugf" >>.tmp/links
	fi
	if [ -s .debuginfo/src/"$debugf" ]; then
		LC_ALL=C sort -m -u -o .tmp/src .tmp/src .debuginfo/src/"$debugf"
	fi
done

sed 's|\(.*\)/.*|\1|' .tmp/files .tmp/links .tmp/src |sort -u |
while read -r dir; do
	while [ -n "$dir" ]; do
		case $dir in
			/usr/lib/debug/usr/*/*)
				printf '%s\n' "$dir" ;;
			/usr/lib/debug/usr/*)
				break ;;
			/usr/lib/debug/*/*)
				printf '%s\n' "$dir" ;;
			/usr/lib/debug/*)
				break ;;
			/usr/src/debug/*)
				printf '%s\n' "$dir" ;;
			*)
				break ;;
		esac
		dir=${dir%/*}
	done
done |
sort -u |
sed 's/^/%dir /'

sort .tmp/files .tmp/links .tmp/src
