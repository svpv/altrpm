#!/bin/sh -e -f +B
#
# strip_files - strip files helper.
#
# Copyright (C) 2000-2002  Dmitry V. Levin <ldv@altlinux.org>
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA
#

PROG="${0##*/}"

StripNote()
{
	if ! objdump -h "$1" |grep '^[ 	]*[0-9]*[ 	]*\.note[ 	]' -A 1 |fgrep -q ALLOC; then
		echo -n '-R .note'
	fi
}

DoStrip()
{
	f="$1"
	shift
	local opts=
	if [ -z "$STRIP_FORCED" ]; then
		opts="-p -R .comment $(StripNote "$f") $*"
	fi
	strip $opts $STRIP_FORCED_OPTS "$f"
}

rc=0
for f in "$@"; do
	if [ ! -f "$f" ]; then
		echo "$PROG: $f: file unavailable" >&2
		rc=1
		continue
	fi

	if [ -n "$RPM_STRIP_SKIPLIST" ]; then
		for skip in $RPM_STRIP_SKIPLIST; do
			if [ -z "${f//$skip}" ]; then
				continue 2
			fi
		done
	fi

	t="$(/usr/bin/file -b "$f")"

	if [ -z "${t/*ELF*executable,*/}" ]; then
		if [ -n "$STRIP_EXECUTABLE" ]; then
			DoStrip "$f"
		fi
		continue
	fi

	if [ -z "${t/*ELF*relocatable,*/}" ]; then
		if [ -n "$STRIP_RELOCATABLE" ]; then
			DoStrip "$f" --strip-unneeded
		fi
		continue
	fi
	
	if [ -z "${t/*ELF*shared object,*/}" ]; then
		if [ -n "$STRIP_SHARED" ]; then
			DoStrip "$f" --strip-unneeded
		fi
		continue
	fi
	
	if [ -z "${t/*current ar archive/}" ]; then
		if [ -n "$STRIP_STATIC" ]; then
			DoStrip "$f" --strip-unneeded
		fi
		continue
	fi
done

exit $rc
